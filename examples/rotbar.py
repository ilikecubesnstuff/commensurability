import numpy as np

from astropy import units as u
from galpy import potential, orbit

from commensurability.tessellation import Tessellation

from utils import example, main, examples_namespace

rotbar = [
    potential.NFWPotential(
        conc = 10,
        mvir = 1,
    ),
    potential.MiyamotoNagaiPotential(
        amp = 5e10 * u.solMass,
        a = 3 * u.kiloparsec,
        b = 0.1 * u.kiloparsec,
    ),
    potential.SoftenedNeedleBarPotential(
        amp = 10e9 * u.solMass,
        a = 1.5 * u.kiloparsec,
        b = 0 * u.kiloparsec,
        c = 0.5 * u.kiloparsec,
        omegab = 2
    ),
    potential.NonInertialFrameForce(
        Omega = 2,
    )
]


def result_factory(name, p, x):
    @example(name)
    def result():
        o = orbit.Orbit([
            x[0] * u.kpc, 
            x[1] * u.km/u.s, 
            x[2] * u.km/u.s, 
            0 * u.kpc, 
            0 * u.km/u.s, 
            0 * u.deg
        ])
        ts = np.linspace(0., 4., 2001) * u.Gyr
        print('integrating...')
        o.integrate(ts, p, progressbar=True)

        print('tessellating...')
        tess = Tessellation.from_galpy_orbit(o, dims=('x', 'y'))
        print(tess.area)
        tess.plot_tessellation_trimming(plot_included=False, plot_points=True)
        tess.plot_tessellation_trimming(plot_included=True, plot_points=False)

result_factory("rotbar 0", rotbar, [1.4735869917752378, -2.1455931453585116e-08, -83.6010368968788])  # area=0.9644275223676669
result_factory("rotbar 1", rotbar, [1.2119748328052786, 0.0, -22.97037153104445])  # area=0.9564796222796642
result_factory("rotbar 2", rotbar, [4.274260792827288, -0.031428738176877434, -52.83349805699617])  # area=0.14926728695803812
result_factory("rotbar 3", rotbar, [3.0107140917122255, 5.7654200342395345e-06, -74.58378830342133])  # area=0.9072338002859512
result_factory("rotbar 4", rotbar, [4.303667326711398, -0.0036330880349786246, -107.11423550490272])  # area=0.782620570083628
result_factory("rotbar 5", rotbar, [1.9379588762732427, 1.0597517006314066e-05, -105.14004188397512])  # area=0.9817471339270312
result_factory("rotbar 6", rotbar, [3.1706410100910105, -1.1528591924554378e-07, -83.3217396664217])  # area=0.30684646489575135
result_factory("rotbar 7", rotbar, [4.412800348000372, -0.004320583752972249, -33.03367139693718])  # area=0.1681281282506974
result_factory("rotbar 8", rotbar, [2.3610437601573246, 0.022392997859012286, -142.99674636435765])  # area=0.8371715157215026
result_factory("rotbar 9", rotbar, [3.8013962658219254, -7.101885168258837, -7.039028635320165])  # area=0.000640497594744854
result_factory("rotbar 10", rotbar, [3.974231813194705, -0.0014820285162085239, -18.91749355204422])  # area=0.05422375876117032
result_factory("rotbar 11", rotbar, [2.643803053748292, -1.5678900203081164e-07, -12.378141668774106])  # area=0.39832495636423565
result_factory("rotbar 12", rotbar, [4.5905140831120335, -0.01652276693380266, -49.04783388063701])  # area=0.014984030898710008
result_factory("rotbar 13", rotbar, [3.6809959568470902, 7.712402428948506e-06, -14.236034093213819])  # area=0.26077416698113776
result_factory("rotbar 14", rotbar, [1.7022680654888462, 1.429950460178428e-06, -141.30740537921568])  # area=0.9058362848159489
result_factory("rotbar 15", rotbar, [2.4152203878230365, 0.0, -96.32764819399361])  # area=0.1319344741685748
result_factory("rotbar 16", rotbar, [2.0987850762824145, -0.0008395498853448512, -118.47456133121563])  # area=0.936664828404242
result_factory("rotbar 17", rotbar, [1.0811500613159883, 0.0, -52.81794700052904])  # area=0.8770031756746142
result_factory("rotbar 18", rotbar, [-3.950706639491522, -0.010570812775315606, -20.26605954857186])  # area=0.3724572090003529
result_factory("rotbar 19", rotbar, [4.028322753961139, 1.1053619977803315e-05, -145.51583191161515])  # area=0.4038849581275033
result_factory("rotbar 20", rotbar, [0.9739450983138555, -0.02397821512598807, -23.044460128663186])  # area=0.949667445110801
result_factory("rotbar 21", rotbar, [0.5709140463530114, 0.0004148655017073625, -147.34693240673906])  # area=0.8447169830816962
result_factory("rotbar 22", rotbar, [2.728696785061113, 3.8682351867296266e-05, -64.41783892567899])  # area=0.13106013297726554
result_factory("rotbar 23", rotbar, [3.135378079001138, -7.124707042470063e-05, -80.45556911783268])  # area=0.6900555277439668
result_factory("rotbar 24", rotbar, [3.148504937116839, 1.322520314004076e-05, -112.4032215405001])  # area=0.6463099700501207
result_factory("rotbar 25", rotbar, [4.140304498181837, -18.817837242670464, -55.361968437575214])  # area=0.04032171655822585
result_factory("rotbar 26", rotbar, [3.2402016289891495, 6.04814326500108e-08, -65.90193059572277])  # area=0.8153165690832535
result_factory("rotbar 27", rotbar, [4.6075336307094155, 0.0, -145.1612037426867])  # area=0.880162618618297
result_factory("rotbar 28", rotbar, [4.156309978900609, 0.00012878734960367113, -25.43891592290452])  # area=0.059553417190782346
result_factory("rotbar 29", rotbar, [0.6065750397993782, -0.8763229953011717, -122.37435397936287])  # area=0.9318124460706855
result_factory("rotbar 30", rotbar, [3.6052899876331423, 5.74757651444817e-07, -116.51115046981775])  # area=0.737524195902167
result_factory("rotbar 31", rotbar, [1.566445437090555, -0.00012476324687436436, -11.076677304134048])  # area=0.7920130809659065
result_factory("rotbar 32", rotbar, [4.045052322054694, -0.014531988889756733, -32.792526384090515])  # area=0.0107129830453023
result_factory("rotbar 33", rotbar, [-19.571355019783304, -0.014504126529538166, -46.00483803214213])  # area=0.9711592430123754
result_factory("rotbar 34", rotbar, [3.335092526946171, -0.06461373898255718, -15.586163195606153])  # area=0.5320846105712622
result_factory("rotbar 35", rotbar, [4.3319645498803006, -0.003184594278368382, -95.64943973480078])  # area=0.7237777632458351
result_factory("rotbar 36", rotbar, [2.3160602797192626, 4.7433576694125226e-08, -77.51988109948803])  # area=0.29276560707978483
result_factory("rotbar 37", rotbar, [3.8028912445467724, -0.00032209792549680184, -2.341129491620763])  # area=0.06873113434125484
result_factory("rotbar 38", rotbar, [3.9484112037372796, 0.0, -52.86978381245287])  # area=0.5590001047989238
result_factory("rotbar 39", rotbar, [4.422776394627157, -0.0005711205303668976, -37.522905929274856])  # area=0.22763633460708133
result_factory("rotbar 40", rotbar, [2.4612216418969064, -5.0167486177917764e-14, -141.99427569382675])  # area=0.8581793710569436
result_factory("rotbar 41", rotbar, [3.894504851455956, -0.0030041604896848886, -75.0454211823233])  # area=0.7947575394266571
result_factory("rotbar 42", rotbar, [2.61930033087244, 5.112121836429411e-06, -26.28944160458181])  # area=0.3190654276882456
result_factory("rotbar 43", rotbar, [3.7482833127767132, -0.00019032204896080027, -1.8901785048232855])  # area=0.004443791479069732
result_factory("rotbar 44", rotbar, [3.195607017935534, -3.801378447805131e-06, -35.94034971672702])  # area=0.3962653117849629
result_factory("rotbar 45", rotbar, [4.058273035279288, 0.0009698550184968555, -57.770554902613654])  # area=0.4732472748172164
result_factory("rotbar 46", rotbar, [3.5776594579393217, 8.017519994692077e-11, -148.31209738308974])  # area=0.3350748036797769
result_factory("rotbar 47", rotbar, [0.8929744514043728, 0.0005849150269600254, -87.14750089154536])  # area=0.781975962729619
result_factory("rotbar 48", rotbar, [3.332905583067891, -8.951905552178726e-08, -74.27886246698182])  # area=0.7434476487676129
result_factory("rotbar 49", rotbar, [2.7647584149037363, 8.197707751083681e-05, -56.80129564462635])  # area=0.42971259619619623
result_factory("rotbar 50", rotbar, [1.8280713193726439, 0.0, -67.08962873939015])  # area=0.9510774860357485
result_factory("rotbar 51", rotbar, [2.426178439337366, -2.3140548726723726e-05, -144.36099732643487])  # area=0.8757071803757852
result_factory("rotbar 52", rotbar, [4.564235413111613, -4.06900317841828, -46.42664132074691])  # area=0.015398676280557655
result_factory("rotbar 53", rotbar, [3.1229239140482794, 5.796911698812453e-06, -80.15857708508138])  # area=0.4480064367388957
result_factory("rotbar 54", rotbar, [4.424133299158431, 2.090208471071306, -88.75700028858657])  # area=0.24312605767647866
result_factory("rotbar 55", rotbar, [3.334113109501761, 0.0, -36.53029458311175])  # area=0.8721530656869596
result_factory("rotbar 56", rotbar, [6.27984100092785, -0.27892213752156125, -148.04160700123674])  # area=3.4236340502272004e-05
result_factory("rotbar 57", rotbar, [1.6917172914703111, -0.00010512246724388884, -112.02733165545315])  # area=0.974482633754217
result_factory("rotbar 58", rotbar, [1.5173880564039746, -0.3272048554299312, -97.39828847083417])  # area=0.944334920914102
result_factory("rotbar 59", rotbar, [2.471633750864708, -2.748210962878492e-05, -130.04734637867915])  # area=0.9208252532383984
result_factory("rotbar 60", rotbar, [1.6906449468997486, 0.0, -7.4582166098832445])  # area=0.96300508557162
result_factory("rotbar 61", rotbar, [4.965513983810231, -0.002117531511154385, -74.21903097760608])  # area=0.0742877532062155
result_factory("rotbar 62", rotbar, [2.0479247185774656, -0.2559874880504873, -132.26982553411693])  # area=0.9637051847406531
result_factory("rotbar 63", rotbar, [4.447648369791353, -9.575117173008543, -117.98241516784428])  # area=0.6660658918295911
result_factory("rotbar 64", rotbar, [5.075262462207104, 2.7603005967734888e-05, -49.70864230904522])  # area=0.007757369466959138
result_factory("rotbar 65", rotbar, [0.23850717568113744, -0.0004465392013129982, -69.0754172545037])  # area=0.9286563578989643
result_factory("rotbar 66", rotbar, [4.570382988862955, -3.674942737840585, -47.035672218306125])  # area=0.015106939234857116
result_factory("rotbar 67", rotbar, [2.0501027192131613, -1.1949951521576e-05, -14.27483767911073])  # area=0.21887944888417155
result_factory("rotbar 68", rotbar, [1.7790143736809414, 0.0, -95.03571361177613])  # area=0.9857119066697391
result_factory("rotbar 69", rotbar, [1.6628643914769239, 0.025876331569117453, -123.76493315976569])  # area=0.9476010484069401
result_factory("rotbar 70", rotbar, [1.3440068008164503, 2.3822419666132084e-09, -1.5553278577183782])  # area=0.5803871339506957
result_factory("rotbar 71", rotbar, [3.2435652725226314, -6.870775559291913e-06, -43.11906538319092])  # area=0.7507597565547676
result_factory("rotbar 72", rotbar, [2.9849310306461, 0.0, -121.5766906478519])  # area=0.9561631437020875
result_factory("rotbar 73", rotbar, [2.0377006960509, 4.4374220519671736e-05, -97.83912746470183])  # area=0.9631854443691528
result_factory("rotbar 74", rotbar, [3.3177297057554394, -3.1401006820010194e-05, -148.4334476038495])  # area=0.9773763533240902
result_factory("rotbar 75", rotbar, [3.7804537067482986, 0.0, -107.10469293845503])  # area=0.38220952642412204
result_factory("rotbar 76", rotbar, [1.3776897110528972, 0.0, -22.420194306142253])  # area=0.9622743446689531
result_factory("rotbar 77", rotbar, [0.831506393817909, -0.0001046187917082291, -142.6863467941792])  # area=0.9347716534861745
result_factory("rotbar 78", rotbar, [2.819284909085507, -6.027379875486929e-10, -70.05749887925522])  # area=0.25833618727103336
result_factory("rotbar 79", rotbar, [2.3424047204157157, 1.5234144225052502e-06, -47.504610071396826])  # area=0.5736430059709776
result_factory("rotbar 80", rotbar, [1.93760862283347, -7.217604015912633e-09, -7.606822514623726])  # area=0.29736860370076823
result_factory("rotbar 81", rotbar, [3.0862203140894766, 2.5342773450519785e-06, -26.436791576672434])  # area=0.894584975742978
result_factory("rotbar 82", rotbar, [2.1341663819570944, 0.5898194873190564, -135.9159884981114])  # area=0.9471064968906052
result_factory("rotbar 83", rotbar, [4.6513526409595585, -0.0006740557042241844, -80.72279557875454])  # area=0.39706078437238235
result_factory("rotbar 84", rotbar, [4.535041475972508, 0.0, -13.823898859983109])  # area=0.5088981015526661
result_factory("rotbar 85", rotbar, [1.4788443576591157, -1.0007808028708598, -36.919552901838614])  # area=0.6218338553822748
result_factory("rotbar 86", rotbar, [2.437972004044795, -2.4279576615210665e-07, -31.331245952483062])  # area=0.33134121001970657
result_factory("rotbar 87", rotbar, [4.22897028035002, -0.01840208110365501, -69.2798776771275])  # area=0.3820170571025169
result_factory("rotbar 88", rotbar, [2.8908723844400352, 0.0, -149.5869719126904])  # area=0.9680954292966703
result_factory("rotbar 89", rotbar, [4.348949615409693, -3.0134583389837096e-05, -82.75264323240668])  # area=0.45396024450348926
result_factory("rotbar 90", rotbar, [2.788653541542152, 0.0, -70.59841961316036])  # area=0.6343717792878315
result_factory("rotbar 91", rotbar, [5.451544206114811, -0.007736491387274783, -103.82672367126769])  # area=7.544624746466376e-07
result_factory("rotbar 92", rotbar, [1.4638272080740997, -0.003750940781145972, -127.98778782072253])  # area=0.9878810721124132
result_factory("rotbar 93", rotbar, [4.714581775217032, 8.061919485780633, -61.45063691971823])  # area=0.03286273782705009
result_factory("rotbar 94", rotbar, [4.956460750544166, 1.5696495729010935e-05, -130.5804565310406])  # area=0.14676080462242871
result_factory("rotbar 95", rotbar, [3.6506559268123424, 0.0, -83.69155595950302])  # area=0.8783456953226331
result_factory("rotbar 96", rotbar, [4.5754713298038245, -0.001547669948058008, -109.8645977775831])  # area=0.44954686583641384
result_factory("rotbar 97", rotbar, [2.7312435223738514, 0.0, -107.11999177049302])  # area=0.9050914072111039
result_factory("rotbar 98", rotbar, [2.744185828921744, 0.0, -126.32224598193186])  # area=0.8908589070515821
result_factory("rotbar 99", rotbar, [4.008880550974349, 0.0, -108.21319613816509])  # area=0.879227585516022


@example()
def default():
    for f in examples_namespace.values():
        f()


if __name__ == '__main__':
    main(default=default)